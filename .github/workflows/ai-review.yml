name: AI Code Review

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_ref', pr.head.ref);
            return pr;
      
      - name: Get PR diff
        id: get-diff
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          git fetch origin ${{ steps.pr-info.outputs.head_ref }}
          DIFF=$(git diff origin/${{ steps.pr-info.outputs.base_ref }}...origin/${{ steps.pr-info.outputs.head_ref }})
          
          # Save diff to file
          echo "$DIFF" > pr_diff.txt
          
          # Check if diff is too large (limit to ~15000 chars to avoid token limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 15000 ]; then
            echo "Diff too large, summarizing..."
            git diff origin/${{ github.base_ref }}...HEAD --stat > pr_diff.txt
            echo -e "\n\n---\nNote: Full diff was too large, showing summary only." >> pr_diff.txt
          fi
      
      - name: AI Code Review
        id: ai-review
        continue-on-error: true
        env:
          ARVAN_API_KEY: ${{ secrets.ARVAN_AI_API_KEY }}
        run: |
          # Read the diff
          DIFF_CONTENT=$(cat pr_diff.txt | jq -Rs .)
          
          # Prepare the review prompt
          PROMPT="You are an expert code reviewer. Please review the following code changes and provide:
          1. A summary of the changes
          2. Potential issues or bugs
          3. Security concerns if any
          4. Performance considerations
          5. Best practices and suggestions for improvement
          6. Positive aspects of the code
          
          Focus on Go code, Kubernetes manifests, and Helm charts.
          
          Code diff:
          $DIFF_CONTENT"
          
          # Call ArvanCloud AI API
          RESPONSE=$(curl -s -X POST \
            "https://arvancloudai.ir/gateway/models/GPT-5/dLeqgnGfz1C2zftmNeS4Nd9Q0Fb33Qx5JRqplYEFa4yWAFRC8saj2LMJiyMAjrDOedL4qNXb_PMDMjCSnEFqSCQkgVFnCx3T4Qtu-sruzmH-wRNhYvxHSI34EjG_nfnoOe9djzeqGnhfCJlQ-Z3zUowQQYYeg510o8t8FtAWu35poiK93SAFBYWkU_bbOCe_ZU3gg8dBzzFwpXgD2z4BWzYhz96DR1jTXOanCnI7gw4/v1/chat/completions" \
            -H "Authorization: Bearer $ARVAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-5\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert code reviewer specializing in Go, Kubernetes, and cloud-native applications.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ],
              \"temperature\": 0.3,
              \"max_tokens\": 2000
            }")
          
          # Extract the review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Error: Unable to get AI review"')
          
          # Save review to file
          echo "$REVIEW" > review.txt
          
          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "API Error: $ERROR_MSG"
            echo "API Error: $ERROR_MSG" > review.txt
          fi
      
      - name: Post AI Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.txt', 'utf8');
            
            const comment = `## ðŸ¤– AI Code Review
            
            ${reviewContent}
            
            ---
            *This review was automatically generated by AI. Please use your judgment and verify the suggestions.*`;
            
            // Check if there's already an AI review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ¤– AI Code Review')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: comment
              });
            }
