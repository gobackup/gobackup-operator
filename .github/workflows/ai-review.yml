name: AI Code Review

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pr_number }}
            });
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_ref', pr.head.ref);
            return pr;
      
      - name: Get PR diff
        id: get-diff
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          git fetch origin ${{ steps.pr-info.outputs.head_ref }}
          DIFF=$(git diff origin/${{ steps.pr-info.outputs.base_ref }}...origin/${{ steps.pr-info.outputs.head_ref }})
          
          # Save diff to file
          echo "$DIFF" > pr_diff.txt
          
          # Check if diff is too large (limit to ~15000 chars to avoid token limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 15000 ]; then
            echo "Diff too large, summarizing..."
            git diff origin/${{ github.base_ref }}...HEAD --stat > pr_diff.txt
            echo -e "\n\n---\nNote: Full diff was too large, showing summary only." >> pr_diff.txt
          fi
      
      - name: AI Code Review
        id: ai-review
        continue-on-error: true
        env:
          ARVAN_API_KEY: ${{ secrets.ARVAN_AI_API_KEY }}
        run: |
          # Read the diff
          DIFF_CONTENT=$(cat pr_diff.txt | jq -Rs .)
          
          # Prepare the review prompt
          PROMPT="Act as a senior Go and Kubernetes engineer. Review the diff and point out only real bugs, security concerns, or risky changes. Keep the review concise and specific, referencing files or resources when it helps. If there is nothing actionable to flag, respond with NO_ISSUES and nothing else.
          
          Code diff:
          $DIFF_CONTENT"
          
          # Call ArvanCloud AI API
          RESPONSE=$(curl -s -X POST \
            "https://arvancloudai.ir/gateway/models/GPT-5/dLeqgnGfz1C2zftmNeS4Nd9Q0Fb33Qx5JRqplYEFa4yWAFRC8saj2LMJiyMAjrDOedL4qNXb_PMDMjCSnEFqSCQkgVFnCx3T4Qtu-sruzmH-wRNhYvxHSI34EjG_nfnoOe9djzeqGnhfCJlQ-Z3zUowQQYYeg510o8t8FtAWu35poiK93SAFBYWkU_bbOCe_ZU3gg8dBzzFwpXgD2z4BWzYhz96DR1jTXOanCnI7gw4/v1/chat/completions" \
            -H "Authorization: Bearer $ARVAN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-5\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert code reviewer specializing in Go, Kubernetes, and cloud-native applications.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ],
              \"temperature\": 0.3,
              \"max_tokens\": 2000
            }")
          
          # Extract the review content
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // ""')
          HAS_ISSUES=false

          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            REVIEW="AI review failed: $ERROR_MSG"
            HAS_ISSUES=false
          else
            TRIMMED=$(echo "$REVIEW" | tr -d '[:space:]')
            if [ -z "$TRIMMED" ] || [ "$TRIMMED" = "NO_ISSUES" ]; then
              HAS_ISSUES=false
              REVIEW="NO_ISSUES"
            else
              HAS_ISSUES=true
            fi
          fi

          # Save review to file
          echo "$REVIEW" > review.txt
          echo "has_issues=$HAS_ISSUES" >> "$GITHUB_OUTPUT"
      
      - name: Post AI Review Comment
        if: steps.ai-review.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.txt', 'utf8').trim();
            const marker = '<!-- ai-review -->';
            const header = '### AI Code Review (automated)\n\n';
            const comment = `${header}${reviewContent}\n\n${marker}`;

            // Check if there's already an AI review comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes(marker)
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: comment
              });
            }
